name: dbt BigQuery

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: ['main']
    paths:
      - models/**
      - tests/**

env:
  # dbt env variables used in your dbt profiles.yml
  DBT_PROFILES_DIR: ./
  DBT_GOOGLE_KEYFILE: /tmp/google/google-service-account.json
  
  # the contents of the keyfile pulled from GitHub Actions secrets 
  KEYFILE_CONTENTS: ${{ secrets.GOOGLE_CLOUD_CREDENTIALS }}

jobs:
  build:
    name: install and build dbt
    runs-on: ubuntu-latest

    steps:

      # Prep Google keyfile
      - run: mkdir -p "$(dirname $DBT_GOOGLE_KEYFILE)" 
      - run: echo "$KEYFILE_CONTENTS" > $DBT_GOOGLE_KEYFILE
    
      - name: Install Python 3.13
        uses: actions/setup-python@v4
        with:
          python-version: 3.13

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dbt
        run: |
          pip install dbt-bigquery
          dbt deps
          dbt --version

      - name: Run dbt
        run: dbt build